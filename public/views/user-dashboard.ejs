<%- include("partials/layout-top", { title: "My Dashboard" }) %>

<%
  const data = summary || {};
  const bills = Array.isArray(recentBills) ? recentBills : [];
  const payments = Array.isArray(recentPayments) ? recentPayments : [];
  const monthReports = Array.isArray(monthlyReport) ? monthlyReport : [];
%>

<section class="card page-head">
  <h2>User Dashboard</h2>
  <p>Overview of your meters, bills, and recent payments.</p>
  <div class="actions">
    <a class="btn" href="<%= rolePath('/bills') %>">View All Bills</a>
    <a class="btn secondary" href="<%= rolePath('/payments') %>">View All Payments</a>
    <a class="btn secondary" href="#monthly-expense-report">Monthly Expense Report</a>
  </div>
</section>

<% if (error) { %>
  <section class="card">
    <p class="muted"><%= error %></p>
  </section>
<% } %>

<section class="split">
  <article class="card">
    <h3>Meters</h3>
    <p><strong><%= data.metersCount || 0 %></strong></p>
  </article>
  <article class="card">
    <h3>Total Bills</h3>
    <p><strong><%= data.billsCount || 0 %></strong></p>
  </article>
  <article class="card">
    <h3>Paid Bills</h3>
    <p><strong><%= data.paidBillsCount || 0 %></strong></p>
  </article>
  <article class="card">
    <h3>Unpaid / Overdue</h3>
    <p><strong><%= data.unpaidBillsCount || 0 %></strong></p>
    <p class="muted">Overdue: <%= data.overdueBillsCount || 0 %></p>
  </article>
  <article class="card">
    <h3>Total Due</h3>
    <p><strong><%= formatTHB(data.totalDue || 0) %></strong></p>
  </article>
</section>

<section class="card">
  <h3 id="monthly-expense-report">Monthly Expense Report</h3>
  <% if (!monthReports.length) { %>
    <div class="empty">No monthly expense data available.</div>
  <% } else { %>
    <table>
      <thead>
        <tr>
          <th>Bill Month</th>
          <th>Total Bills</th>
          <th>Paid</th>
          <th>Unpaid</th>
          <th>Overdue</th>
          <th>Payments</th>
          <th>Total Amount (THB)</th>
          <th>Paid Amount (THB)</th>
          <th>Outstanding (THB)</th>
        </tr>
      </thead>
      <tbody>
        <% monthReports.forEach((report) => { %>
          <tr>
            <td><%= report.monthLabel || report.monthKey || "-" %></td>
            <td><%= report.billsCount || 0 %></td>
            <td><%= report.paidBillsCount || 0 %></td>
            <td><%= report.unpaidBillsCount || 0 %></td>
            <td><%= report.overdueBillsCount || 0 %></td>
            <td><%= report.paymentsCount || 0 %></td>
            <td><%= formatTHB(report.totalAmount) %></td>
            <td><%= formatTHB(report.paidAmount) %></td>
            <td><%= formatTHB(report.outstandingAmount) %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  <% } %>
</section>

<section class="card">
  <h3>Recent Bills</h3>
  <% if (!bills.length) { %>
    <div class="empty">No bills found.</div>
  <% } else { %>
    <table>
      <thead>
        <tr>
          <th>Bill ID</th>
          <th>Meter ID</th>
          <th>Amount (THB)</th>
          <th>Due Date</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <% bills.forEach((bill) => { %>
          <% const paid = String(bill.status || "").toLowerCase() === "paid"; %>
          <tr>
            <td><%= bill.bill_id || "-" %></td>
            <td><%= bill.meter_id || "-" %></td>
            <td><%= formatTHB(bill.amount) %></td>
            <td><%= bill.due_date || "-" %></td>
            <td><%= bill.status || "-" %></td>
            <td>
              <% if (paid) { %>
                <span class="muted">Paid</span>
              <% } else { %>
                <a class="btn" href="<%= rolePath('/pay-bill/' + bill.bill_id) %>">Pay Bill</a>
              <% } %>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  <% } %>
</section>

<section class="card">
  <h3>Recent Payments</h3>
  <% if (!payments.length) { %>
    <div class="empty">No payments found.</div>
  <% } else { %>
    <table>
      <thead>
        <tr>
          <th>Payment ID</th>
          <th>Bill ID</th>
          <th>Method</th>
          <th>Date</th>
          <th>Reference</th>
        </tr>
      </thead>
      <tbody>
        <% payments.forEach((p) => { %>
          <tr>
            <td><%= p.payment_id || "-" %></td>
            <td><%= p.bill_id || "-" %></td>
            <td><%= p.payment_method || "-" %></td>
            <td><%= p.payment_date || "-" %></td>
            <td><%= p.transaction_ref || "-" %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  <% } %>
</section>

<%- include("partials/layout-bottom") %>
